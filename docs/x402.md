# X402 Support

X402 is a revolutionary payment protocol that enables seamless micropayments for AI agent interactions. It creates a decentralized economy where AI agents can monetize their services and users can pay for specific AI capabilities on a per-use basis. This protocol is particularly well-suited for AI agents as it allows for:

- **Instant micropayments** for AI services without traditional payment friction
- **Decentralized agent-to-agent communication** enabling complex multi-agent workflows
- **Cryptographic authentication** ensuring secure and verifiable interactions
- **Pay-per-use model** that scales with actual usage rather than subscription fees

IntentKit's integration with X402 enables agents to both consume and provide services through this payment protocol, creating a rich ecosystem of interconnected AI capabilities.

## Accessing Agents through X402

The X402 API provides a standardized way to interact with IntentKit agents using cryptographic payments. This enables secure, authenticated communication between different agents and external applications.

### API Endpoint

The X402 API endpoint for IntentKit agents is:

```
https://open.service.crestal.network/x402
```

### API Structure

**Endpoint:** `POST /x402`

**Request Body:**
```json
{
  "agent_id": "string",
  "message": "string"
}
```

You can find the agent_id from agent detail url, it should be a 20 character long string or a wallet address.

**Response:**
```json
[
  {
    "id": "string",
    "author_type": "agent",
    "message": "string",
    "attachments": [],
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

### TypeScript Client Example

```typescript
import { x402HttpxClient } from 'x402';
import { ethers } from 'ethers';

async function queryAgent(agentId: string, message: string) {
  // Initialize wallet signer
  const wallet = new ethers.Wallet(process.env.PRIVATE_KEY!);
  
  // Create X402 client
  const client = new x402HttpxClient({
    account: wallet,
    baseUrl: 'https://open.service.crestal.network',
    timeout: 20000
  });

  try {
    const response = await client.post('/x402', {
      json: {
        agent_id: agentId,
        message: message
      }
    });

    const messages = await response.json();
    
    // Get the final agent response
    const lastMessage = messages[messages.length - 1];
    return lastMessage.message;
    
  } catch (error) {
    console.error('X402 request failed:', error);
    throw error;
  } finally {
    await client.close();
  }
}

// Usage example
async function main() {
  try {
    const response = await queryAgent('0x92EA73e1ae8c592FB94fE03D5b1eb7ade4c191e4', 'What is the current price of Bitcoin?');
    console.log('Agent response:', response);
  } catch (error) {
    console.error('Error:', error);
  }
}

main();
```

### Python Client Example

```python
import asyncio
import os
from x402.clients.httpx import x402HttpxClient
from eth_account import Account

async def query_agent(agent_id: str, message: str) -> str:
    """Query an IntentKit agent via X402 protocol."""
    
    # Initialize wallet account
    private_key = os.getenv('PRIVATE_KEY')
    if not private_key:
        raise ValueError("PRIVATE_KEY environment variable is required")
    
    account = Account.from_key(private_key)
    
    # Create X402 client
    async with x402HttpxClient(
        account=account,
        base_url='https://open.service.crestal.network',
        timeout=20.0
    ) as client:
        
        # Send request to agent
        response = await client.post('/x402', json={
            'agent_id': agent_id,
            'message': message,
            'app_id': 'my-app'
        })
        
        # Handle response
        response.raise_for_status()
        messages = response.json()
        
        if not messages:
            raise ValueError("Agent returned empty response")
        
        # Return the final agent message
        last_message = messages[-1]
        return last_message['message']

# Usage example
async def main():
    try:
        response = await query_agent(
            agent_id='0x92EA73e1ae8c592FB94fE03D5b1eb7ade4c191e4',
            message='What is the current price of Bitcoin?'
        )
        print(f"Agent response: {response}")
    except Exception as error:
        print(f"Error: {error}")

if __name__ == "__main__":
    asyncio.run(main())
```

## Accessing Other Agents through X402 Skill

IntentKit agents can communicate with other agents using the built-in X402 skill. This enables complex multi-agent workflows where agents can delegate tasks, gather information, or coordinate actions.

### Enabling the X402 Skill

To enable X402 capabilities for your agent, add the X402 skill to your agent configuration:

```
x402_ask_agent
```

### Prompt Examples

Here are some example prompts that demonstrate how to use the X402 skill effectively:

#### Basic Agent Query
```
Ask the crypto-analyst agent about the current Bitcoin price and market trends.
```

#### Multi-Agent Coordination
```
First, ask the market-research agent to analyze the DeFi sector trends. 
Then, ask the portfolio-manager agent to suggest investment allocations based on that analysis.
```

#### Specialized Task Delegation
```
I need help with a complex trading strategy. Ask the quantitative-analyst agent to:
1. Analyze the correlation between ETH and BTC over the last 30 days
2. Provide risk metrics for a 70/30 ETH/BTC portfolio
3. Suggest optimal rebalancing frequency

Then ask the risk-manager agent to validate these recommendations.
```

#### Cross-Domain Expertise
```
Ask the legal-advisor agent about regulatory compliance for DeFi protocols in the US, 
then ask the technical-architect agent how to implement those compliance requirements 
in a smart contract system.
```

#### Information Aggregation
```
Gather market sentiment from multiple sources:
- Ask the social-sentiment agent about crypto Twitter trends
- Ask the news-analyzer agent about recent regulatory news
- Ask the technical-analyst agent about chart patterns
- Synthesize all this information into a comprehensive market outlook
```

### Advanced Usage Patterns

#### Conditional Agent Queries
```
If the current Bitcoin price is above $50,000, ask the momentum-trader agent for bullish strategies.
Otherwise, ask the value-investor agent for accumulation strategies.
```

#### Agent Chain Workflows
```
Create a research pipeline:
1. Ask the data-collector agent to gather the latest DeFi TVL data
2. Pass that data to the trend-analyzer agent for pattern recognition
3. Have the report-generator agent create a summary report
4. Finally, ask the presentation-agent to format it for stakeholders
```

## Accessing Other Resources through X402

TBD
